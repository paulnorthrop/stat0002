---
title: "Chapter 8: Contingency tables"
author: "Paul Northrop"
date: ""
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Chapter 8: Contingency tables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: stat0002.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(comment = "", prompt = TRUE, collapse = TRUE,
                      fig.width = 7, fig.height = 5, fig.align = 'center')

required <- c("vcd")

if (!all(unlist(lapply(required, function(pkg) requireNamespace(pkg, quietly = TRUE)))))
  knitr::opts_chunk$set(eval = FALSE)
```

This vignette provides some R code that is related to some of the content of [Chapter 8 of the STAT0002 notes](https://paulnorthrop.github.io/stat0002book/contingency.html#contingency), namely to Contingency tables.  It contains some technical information about classes of R objects and the way in which this affects what R does when we call functions to operate on an object. If this interests you then great, but otherwise, focus on what the code below does rather than exactly how it works.

## Graduate Admissions at Berkeley

We return to data that we considered briefly in the 
[Chapter 3: Probability](https://paulnorthrop.github.io/stat0002/articles/stat0002-ch3-probability-vignette.html) article. The object `berkeley` is a 3-dimensional array that contains information about applicants to graduate school at UC Berkeley in 1973 for the six largest departments. Use `?UCBAdmissions` for more information. The 3 dimensions of the array correspond to the gender of the applicant (dimension named `Gender`), whether or not they were admitted (named `Admit`) and a letter code for the department to which they applied (named `Dept`).  A given entry in `berkeley` gives the total number of applicants in the corresponding (`Admit`, `Gender`, `Dept`) category. 
In Chapter 3, we viewed these data are relating to a population containing the 4526 people who applied to graduate school at Berkeley in 1973 and did not seek to generalise beyond this population. In other words, we treated the relative frequencies in the various categories as known probabilities.  Now, we view these data as a sample of data that may help us to make inferences about the application at Berkeley in general. In particular, we will explore associations between the categorical variables (`Admit`, `Gender`, `Dept`), or perhaps just two of these variables.  Note that, following standard statistical terminology, R refers to categorical variables as **factors** and the possible values of these factors as **levels**.

```{r, message = FALSE}
library(stat0002)
```

## The data

The `berkeley` dataset is a $2 \times 2 \times 6$ contingency table.  For each of the 6 departments involved there is a $2 \times 2$ table for variables `Admit` and `Gender`.

```{r}
# Find the dimensions of the data
dim(berkeley)
# What type of R object is berkeley?
class(berkeley)
# Print the data
berkeley
```

### Classes of R objects

Many objects in R have a `class` attribute that that contains a (character) vector of names, perhaps just one name, that describes what type of object it is.  This is useful because for some types of object have standard `methods` are provided, to perform common tasks like printing, summarising and plotting. In the code above, instead of typing `berkeley` we could have typed `print(berkeley)`. When we do this R searches for an appropriate way to print to the Console the object `berkeley`, which has class `"table"`.  R looks for, and finds, a function `print.table` to use to do this printing.  We will come back to this later, for example when we consider producing plots of contingency table data.

## 2-way tables

We need to **collapse** the 3-way table to a 2-way table by ignoring the values of one of the 3 categorical variables.  One way to do this is to use the `xtabs` function in the `stats` package, which comes as standard when you install R.  To use `xtabs` we need first to modify the structure of the data from a table to a data frame. Then the following call to `xtabs` creates a 2-way table in which frequency is classified by `Gender` and `Admit`.  We have aggregated (summed) `Freq` within each `Gender-Admit` category, over all the values of `Dept`.  Similarly, we could ignore `Gender` or `Admit` to produce a 2-way table for the remaining two variables.

```{r genderadmit}
df <- as.data.frame(berkeley)
df
ga <- xtabs(Freq ~ Gender + Admit, df)
ga
```

If we think about how the variables in this 2-way table may be related we might imagine that `Gender` could affect the value of `Admit`, that is, the gender of the applicant could affect the probability that the applicant is admitted. That is, `Gender` could have a causal effect on `Admit`, which is the main variable of interest in this example.  In cases like this, we call `Admit` the **response** variable and `Gender` the **explanatory** variable because it may explain variation in the response variable.  It is natural to consider conditional probabilities of the levels of `Admit` given the value of `Gender` and we may wish to create our plots with this in mind.

Functions are available for calculating the totals and proportions that appear in [Section 8.1](https://paulnorthrop.github.io/stat0002book/contingency.html#way2) of the notes and in the [Berkeley example](https://paulnorthrop.github.io/stat0002book/probability.html#example-graduate-admissions-at-berkeley-continued) in Chapter 3 of the notes.

```{r}
# Total number of applicants
marginSums(ga)
# Number of males and females
marginSums(ga, "Gender")
# Number of accepted and rejected applicants
marginSums(ga, "Admit")
# Add the marginal totals to the table
addmargins(ga)
# Calculate proportions (relative frequencies)
proportions(ga)
# Row proportions (sum to 1 across the rows)
proportions(ga, "Gender")
# Column proportions (sum to 1 down the columns)
proportions(ga, "Admit")
```

What class does `ga` have?

```{r}
class(ga)
```

### Plotting frequencies

The object `ga` has 2 things in its vector class names: `"xtabs"` and `"table"`.  This means that we have available to us any methods functions that have been created for use on objects of class `"xtabs"` or class `"table"`.  If, for example, we use the code `plot(ga)` then, because `"xtabs"` appears first in the vector of class names, R looks first for a function called `plot.xtabs`.  If it does not find a function with this name then it looks for `plot.table`.  If it find neither then it uses the function `plot.default`. The function `plot.default` definitely exists, but because it has not been designed for a specific input object then it might not work. In this case, there is no function `plot.xtabs` but there is a function `plot.table`. If the table has at least 2 factors then this call the function `mosaicplot` in the `graphics` package, which also comes as standard when you install R. Let's see what happens if we do this. 

```{r}
plot(ga, main = "Observed frequencies", color = TRUE)
```

A **mosaic** plot is produced. First, the plot area is first split into two parts vertically, with the sizes of the parts reflecting the marginal distribution of the first variable (`Gender` here).  That is, the widths of the vertical rectangles are proportional to the numbers of males and females respectively. We can see that there are more males in the data than females.  Then similar splits are made horizontally within **each** of the vertical parts, with the sizes of the parts determined by the conditional distribution of the second variable (`Admit`) conditional on the value of the first variable, that is, conditional on `Gender = Male` and `Gender = Female`. 

Recall that we said earlier that it made sense to considered conditioning on `Gender` and this is what has been done in this plot.  Therefore, this plot is pretty much as we would like it to be.  We may prefer to display the conditional distributions `Admit` given `Gender` horizontally in the plot, rather than vertically. The following code achieves this, using the argument `dir`.  The information in the plot is the same but cosmetically it is slightly different.

```{r}
plot(ga, main = "Observed frequencies", color = TRUE, dir = c("h", "v"))
```

We can see that more applicants are rejected than accepted and that the proportion of males that are accepted is greater than the proportion of females that are accepted.

If we had placed the variables in the data frame in the other order then, unless we make an adjustment, the mosaic plot is produced by conditioning on `Admit` first, producing the following plot.

```{r}
ag <- xtabs(Freq ~ Admit + Gender, df)
ag
plot(ag, main = "Observed frequencies", color = TRUE)
```

This is not wrong, but it concentrates on conditional probabilities of `Gender` given `Admit`, which is not what we want. We can use the argument `sort` to reverse the order in which the mosaic plots takes the variables and produce our preferred plot.

```{r}
plot(ag, main = "Observed frequencies", color = TRUE, sort = 2:1)
```

### Calculating estimated expected frequencies

We estimate expected frequencies under the assumption that the variable `Gender` and `Admit` are independent. We could use R to calculate these for ourselves, using the `outer` function below. Alternatively, can use the function `chisq.test` in the `stats` package.  We will come back to this function later, but for the moment we only want the values of the estimated expected frequencies.  We also produce a mosaic plot of the estimated expected frequencies

```{r}
efreq <- outer(marginSums(ga, "Gender"), marginSums(ga, "Admit")) / marginSums(ga)
efreq
# Check using chisq.test
efreq <- chisq.test(ga)$expected
efreq
# Trick R into using plot.table
class(efreq) <- "table"
# Plot estimated expected frequencies
plot(t(efreq), main = "Estimated expected frequencies", color = TRUE)
```

As we expect, the relative sizes of the estimated expected frequencies for `Admitted` and `Rejected` are the same for males and females.

### Plotting residuals

The `assocplot` function in the `graphics` package produces a plot that summarises how the (Pearson) residuals vary between the combinations of the categories. The vertical extent of a rectangle is proportional to the corresponding Pearson residual and the width is proportional to the square root of the expected frequency.  Therefore, the area of a box is proportional to the raw residual, that is, this difference between the observed and estimated expected frequency. 

```{r}
assocplot(ga)
```

Comparing the rectangles with the horizontal dashed line, we see that more men are admitted than is expected if `Gender` and `Admit` are independent. 

## Testing association

The function `chisq.test` in the `stats` package can be used to perform the chi-squared outlined at the end of [Section 8.1.1](https://paulnorthrop.github.io/stat0002book/contingency.html#indep) of the notes. We specify `correct = FALSE` to produce the same result given in the notes, that is, we do not use the [Yates's correction for continuity](https://en.wikipedia.org/wiki/Yates%27s_correction_for_continuity).

```{r}
chisq.test(ga, correct = FALSE)
```

The value of the test statistic $92.205$ is very much larger than expected under the hypothesis that `Gender` and `Admit` are independent.  Therefore, we would reject hypothesis.

## 3-ways tables

If we have 3 (or more) variables then there are many possible associations that we could examine.

```{r}
x <- berkeley
dimnames(x)$Admit <- c("A", "R")
plot(x, main = "Observed frequencies", sort = 3:1)
```

### The `vcd` package

The `vcd` package (@vcd) provides various functions to summarise, visualise and make inferences using categorical data.  Its functions `mosaic` and `assoc` produce plots that are equivalent to those produced by `plot.table` and `assocplot` above. It deals more easily with some aspects of tables of dimension greater than 2 than the functions in base R.

```{r, warning = FALSE, message = FALSE}
library(vcd)
```

### Mutual independence

As we noted in [Section 8.2.1](https://en.wikipedia.org/wiki/Yates%27s_correction_for_continuity) there seems little point in asking whether the 3 variables `Gender`, `Admit` and `Dept` are independent when we have already concluded that `Gender` and `Admit`
are not independent. However, we perform a chi-squared test in any case, this time, using the generic function `summary`.  For an object of class `table` this function calls `chisq.test` to perform the test and also includes a very basic summary of the table in the output. 

```{r}
summary(berkeley, correction = FALSE)
```

### Marginal independence

```{r}
vcd::mosaic(~ Gender + Admit, data = berkeley)
```

### Conditional independence

```{r}
cotabplot(aperm(UCBAdmissions, c(2,1,3)), panel = cotab_coindep, shade = TRUE,
          legend = FALSE,
          panel_args = list(type = "assoc", margins = c(2,1,1,2), varnames = FALSE))
```

```{r}
vcd::mosaic(~ Admit + Gender | Dept, data = berkeley)
```

```{r}
doubledecker(aperm(aperm(UCBAdmissions, c(1,3,2))[2:1,,], c(2,3,1)),
             margins = c(left = 0, right = 5), col = rev(grey.colors(2)))
```

```{r}
mosaic(aperm(UCBAdmissions, c(3,2,1)), data = UCBAdmissions, split = TRUE,
       shade = TRUE, keep = FALSE, rep = c(Admission = FALSE))
```


## References

<script type="text/x-mathjax-config">
   MathJax.Hub.Config({  "HTML-CSS": { minScaleAdjust: 125, availableFonts: [] }  });
</script>
